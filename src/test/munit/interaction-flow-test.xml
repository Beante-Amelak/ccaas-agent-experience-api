<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
	xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
		http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
		http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

	<!-- MUnit Configuration -->
	<munit:config name="interaction-flow-test.xml"/>

	<!-- ============================================== -->
	<!-- Test: Start Interaction - Success             -->
	<!-- ============================================== -->

	<munit:test name="test-start-interaction-success" description="Test successful interaction start">
		<munit:behavior>
			<!-- Mock CRM System API -->
			<munit-tools:mock-when processor="http:request" doc:name="Mock CRM API">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="CRM_System_API_Config" attributeName="config-ref"/>
				</munit-tools:with-attributes>
				<munit-tools:then-return>
					<munit-tools:payload value="#[output application/json --- {
						customerId: 'CUST-12345',
						name: 'John Doe',
						email: 'john.doe@example.com',
						tier: 'GOLD',
						accountStatus: 'ACTIVE'
					}]" mediaType="application/json"/>
					<munit-tools:attributes value="#[{statusCode: 200}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Billing System API -->
			<munit-tools:mock-when processor="http:request" doc:name="Mock Billing API">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="Billing_System_API_Config" attributeName="config-ref"/>
				</munit-tools:with-attributes>
				<munit-tools:then-return>
					<munit-tools:payload value="#[output application/json --- {
						accountId: 'ACC-001',
						status: 'ACTIVE',
						balance: 150.00
					}]" mediaType="application/json"/>
					<munit-tools:attributes value="#[{statusCode: 200}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock WFM System API -->
			<munit-tools:mock-when processor="http:request" doc:name="Mock WFM API">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="WFM_System_API_Config" attributeName="config-ref"/>
				</munit-tools:with-attributes>
				<munit-tools:then-return>
					<munit-tools:payload value="#[output application/json --- {
						agentId: 'AGT-001',
						status: 'AVAILABLE'
					}]" mediaType="application/json"/>
					<munit-tools:attributes value="#[{statusCode: 200}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Recording System API -->
			<munit-tools:mock-when processor="http:request" doc:name="Mock Recording API">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="Recording_System_API_Config" attributeName="config-ref"/>
				</munit-tools:with-attributes>
				<munit-tools:then-return>
					<munit-tools:payload value="#[output application/json --- {
						requireRecordingConsent: true,
						pciCompliance: true
					}]" mediaType="application/json"/>
					<munit-tools:attributes value="#[{statusCode: 200}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock NICE System API -->
			<munit-tools:mock-when processor="http:request" doc:name="Mock NICE API">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="NICE_System_API_Config" attributeName="config-ref"/>
				</munit-tools:with-attributes>
				<munit-tools:then-return>
					<munit-tools:payload value="#[output application/json --- {
						status: 'CREATED'
					}]" mediaType="application/json"/>
					<munit-tools:attributes value="#[{statusCode: 201}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>

		<munit:execution>
			<set-payload value="#[output application/json --- {
				channel: 'VOICE',
				customerId: 'CUST-12345',
				phoneNumber: '+1-555-123-4567',
				agentId: 'AGT-001',
				metadata: {
					source: 'IVR'
				}
			}]" doc:name="Set Request Payload"/>
			<flow-ref name="post:\interactions\start:ccaas-interaction-process-api-config" doc:name="Call Start Interaction"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:assert-that expression="#[payload.interactionId]" is="#[MunitTools::notNullValue()]" doc:name="Assert Interaction ID exists"/>
			<munit-tools:assert-that expression="#[payload.routingDecision]" is="#[MunitTools::notNullValue()]" doc:name="Assert Routing Decision exists"/>
			<munit-tools:assert-that expression="#[payload.timestamp]" is="#[MunitTools::notNullValue()]" doc:name="Assert Timestamp exists"/>
			<munit-tools:assert-equals actual="#[vars.httpStatus]" expected="#[201]" doc:name="Assert HTTP 201 Status"/>
		</munit:validation>
	</munit:test>

	<!-- ============================================== -->
	<!-- Test: Start Interaction - Partial System Failure -->
	<!-- ============================================== -->

	<munit:test name="test-start-interaction-partial-failure" description="Test interaction start with partial system failure">
		<munit:behavior>
			<!-- Mock CRM System API - Success -->
			<munit-tools:mock-when processor="http:request" doc:name="Mock CRM API Success">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="CRM_System_API_Config" attributeName="config-ref"/>
				</munit-tools:with-attributes>
				<munit-tools:then-return>
					<munit-tools:payload value="#[output application/json --- {
						customerId: 'CUST-12345',
						name: 'Jane Smith',
						tier: 'SILVER'
					}]" mediaType="application/json"/>
					<munit-tools:attributes value="#[{statusCode: 200}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Billing System API - Failure -->
			<munit-tools:mock-when processor="http:request" doc:name="Mock Billing API Failure">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="Billing_System_API_Config" attributeName="config-ref"/>
				</munit-tools:with-attributes>
				<munit-tools:then-return>
					<munit-tools:error typeId="HTTP:CONNECTIVITY"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock WFM System API - Success -->
			<munit-tools:mock-when processor="http:request" doc:name="Mock WFM API Success">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="WFM_System_API_Config" attributeName="config-ref"/>
				</munit-tools:with-attributes>
				<munit-tools:then-return>
					<munit-tools:payload value="#[output application/json --- {}]" mediaType="application/json"/>
					<munit-tools:attributes value="#[{statusCode: 200}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Recording System API -->
			<munit-tools:mock-when processor="http:request" doc:name="Mock Recording API">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="Recording_System_API_Config" attributeName="config-ref"/>
				</munit-tools:with-attributes>
				<munit-tools:then-return>
					<munit-tools:payload value="#[output application/json --- {}]" mediaType="application/json"/>
					<munit-tools:attributes value="#[{statusCode: 200}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock NICE System API -->
			<munit-tools:mock-when processor="http:request" doc:name="Mock NICE API">
				<munit-tools:with-attributes>
					<munit-tools:with-attribute whereValue="NICE_System_API_Config" attributeName="config-ref"/>
				</munit-tools:with-attributes>
				<munit-tools:then-return>
					<munit-tools:payload value="#[output application/json --- {status: 'CREATED'}]" mediaType="application/json"/>
					<munit-tools:attributes value="#[{statusCode: 201}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>

		<munit:execution>
			<set-payload value="#[output application/json --- {
				channel: 'CHAT',
				customerId: 'CUST-12345'
			}]" doc:name="Set Request Payload"/>
			<flow-ref name="post:\interactions\start:ccaas-interaction-process-api-config" doc:name="Call Start Interaction"/>
		</munit:execution>

		<munit:validation>
			<!-- Should still succeed even with partial system failure -->
			<munit-tools:assert-that expression="#[payload.interactionId]" is="#[MunitTools::notNullValue()]" doc:name="Assert Interaction ID exists"/>
			<munit-tools:assert-equals actual="#[vars.httpStatus]" expected="#[201]" doc:name="Assert HTTP 201 Status"/>
		</munit:validation>
	</munit:test>

	<!-- ============================================== -->
	<!-- Test: Complete Interaction - Success          -->
	<!-- ============================================== -->

	<munit:test name="test-complete-interaction-success" description="Test successful interaction completion">
		<munit:behavior>
			<!-- Mock Object Store Contains -->
			<munit-tools:mock-when processor="os:contains" doc:name="Mock OS Contains">
				<munit-tools:then-return>
					<munit-tools:payload value="#[true]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Object Store Retrieve -->
			<munit-tools:mock-when processor="os:retrieve" doc:name="Mock OS Retrieve">
				<munit-tools:then-return>
					<munit-tools:payload value="#[output application/json --- {
						interactionId: 'INT-TEST001',
						channel: 'VOICE',
						customerId: 'CUST-12345',
						status: 'ACTIVE',
						customerContext: {
							tier: 'GOLD'
						}
					}]" mediaType="application/json"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>

			<!-- Mock Object Store Store -->
			<munit-tools:mock-when processor="os:store" doc:name="Mock OS Store">
				<munit-tools:then-return/>
			</munit-tools:mock-when>

			<!-- Mock all HTTP requests -->
			<munit-tools:mock-when processor="http:request" doc:name="Mock All HTTP">
				<munit-tools:then-return>
					<munit-tools:payload value="#[output application/json --- {status: 'SUCCESS'}]" mediaType="application/json"/>
					<munit-tools:attributes value="#[{statusCode: 200}]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>

		<munit:execution>
			<set-variable variableName="interactionId" value="INT-TEST001" doc:name="Set Interaction ID"/>
			<set-payload value="#[output application/json --- {
				disposition: 'RESOLVED',
				wrapUpCode: 'SALES_COMPLETE',
				notes: 'Customer upgraded to premium',
				recordingConsent: true
			}]" doc:name="Set Request Payload"/>
			<flow-ref name="post:\interactions\(interactionId)\complete:ccaas-interaction-process-api-config" doc:name="Call Complete Interaction"/>
		</munit:execution>

		<munit:validation>
			<munit-tools:assert-equals actual="#[payload.status]" expected="#['ACCEPTED']" doc:name="Assert Status ACCEPTED"/>
			<munit-tools:assert-that expression="#[payload.postCallProcessingId]" is="#[MunitTools::notNullValue()]" doc:name="Assert PCP ID exists"/>
			<munit-tools:assert-equals actual="#[vars.httpStatus]" expected="#[202]" doc:name="Assert HTTP 202 Status"/>
		</munit:validation>
	</munit:test>

	<!-- ============================================== -->
	<!-- Test: Complete Interaction - Not Found        -->
	<!-- ============================================== -->

	<munit:test name="test-complete-interaction-not-found" description="Test interaction completion with invalid ID" expectedErrorType="APP:INTERACTION_NOT_FOUND">
		<munit:behavior>
			<!-- Mock Object Store Contains - Returns false -->
			<munit-tools:mock-when processor="os:contains" doc:name="Mock OS Contains False">
				<munit-tools:then-return>
					<munit-tools:payload value="#[false]"/>
				</munit-tools:then-return>
			</munit-tools:mock-when>
		</munit:behavior>

		<munit:execution>
			<set-variable variableName="interactionId" value="INT-INVALID" doc:name="Set Invalid Interaction ID"/>
			<set-payload value="#[output application/json --- {
				disposition: 'RESOLVED'
			}]" doc:name="Set Request Payload"/>
			<flow-ref name="post:\interactions\(interactionId)\complete:ccaas-interaction-process-api-config" doc:name="Call Complete Interaction"/>
		</munit:execution>
	</munit:test>

</mule>